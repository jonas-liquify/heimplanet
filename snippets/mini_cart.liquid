<script>
    document.addEventListener('alpine:init', () => {

    Alpine.data('handleMinicart', () => ({
        init() {
            console.log('handleMinicart init')
        },
        open: false,
        note: null,
        attributes: {},
        original_total_price: 0,
        total_price: 0,
        total_discount: 0,
        total_weight: 0.0,
        item_count: 0,
        products: [],
        requires_shipping: false,
        currency: 'EUR',
        items_subtotal_price: 0,
        cart_level_discount_applications: [],
        cartApiResponseDefault : {
            result : {},
            show : false,
            timeout : 5000,
        },
        cartApiResponse : {
            result : {},
            show : false,
            timeout : 5000,
        },

        // deprecated:
        total: {
            items: 0,
            price: 0,
            weight: 0,
            discount: 0,
        },
        _abortController : null,
        initAbortController() {
            if(this._abortController) {
                this._abortController.abort('abort previous request');
            }
            this._abortController = new AbortController()
        },
        getAbortControllerSignal() {
            return this._abortController.signal
        },
        resetAbortController() {
            this._abortController = null;
        },
        toggleMiniCart() {
            this.getCart();
            this.open = !this.open;
        },

        /**
         * Get the cart data.
         */
        getCart() {
            this.initAbortController()
            fetch(window.Shopify.routes.root + 'cart.js', {
                method: 'GET',
                signal: this.getAbortControllerSignal(),
                headers: {'Content-Type': 'application/json'},
            })
            .then(response => response.json())
            .then(data => {
                this.resetAbortController();
                console.log('Cart (getCart()): ', data, data.items);

                this.total.items = data.item_count;
                this.products = data.items;
                this.total.price = data.total_price;
                this.total.weight = data.total_weight;
                this.total.discount = data.total_discount;

                this.$dispatch('carttotalitems', data.item_count);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        },

        /**
         * @param id
         * @param quantity
         */
        increaseCartItemQuantity(id, quantity) {
            this.updateCartItemQuantity(id, parseInt(quantity) + 1);
        },

        /**
         * @param id
         * @param quantity
         */
        decreaseCartItemQuantity(id, quantity) {
            this.updateCartItemQuantity(id, parseInt(quantity) - 1);
        },

        /**
         * Update the cart item.
         *
         * @param id
         * @param quantity
         */
        updateCartItemQuantity(id, quantity) {
            this.initAbortController();
            console.log('updateCartItemQuantity(): id, quantity: ', id, quantity);
            this.products.filter((product)  => {
                if(parseInt(product.id) === parseInt(id)) {
                    product.quantity = quantity
                }
            })
            fetch(window.Shopify.routes.root + 'cart/change.js', {
                method: 'POST',
                signal: this.getAbortControllerSignal(),
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    id: `${id}`,
                    quantity: quantity,
                }),
            })
                .then(response => response.json())
                .then(data => {
                    this.resetAbortController();
                    console.log('updateCartItemQuantity(): ', data);

                    this.$dispatch('cartupdated');
                    this.$dispatch('showcartmessage', { status: data.status, message: data.message, description: data.description });
                })
                .catch((error) => {
                    console.error('Error:', error);
                    this.$dispatch('showcartmessage', { status: error?.status, message: error, description: error });
                });
        },

        /**
         * Format monetary values.
         */
        moneyFormat(value, minor = true) {
            return LiquifyHelper.moneyFormat(value, minor)
        },

        /**
         * Shows the minicart api message
         * @param event
         */
        showCartMessage(event) {
            console.log("dispatched showCartMessage", event)
            if(event?.detail?.status) {
                this.cartApiResponse.result = event.detail ?? this.cartApiResponseDefault.result;
                this.cartApiResponse.show = true
                setTimeout(() =>  this.cartApiResponse =  this.cartApiResponseDefault, this.cartApiResponse.timeout ?? 5000)
            }
        },
    }))
});


</script>
<div data-hover="false" data-delay="0" li-element="mini-cart" class="nav_dropdown w-dropdown" x-cloak="" x-data="handleMinicart()" x-init="getCart()" @cartupdated.window="getCart()" @setcartitem.window="updateCartItemQuantity($event.detail.product, $event.detail.quantity)" @increasecartitem.window="increaseCartItemQuantity($event.detail.product, $event.detail.quantity)" @decreasecartitem.window="decreaseCartItemQuantity($event.detail.product, $event.detail.quantity)" @toggleminicart.window="toggleMiniCart()" @showcartmessage.window="showCartMessage"><div li-element="mini-cart-trigger" class="nav_shop-icon w-dropdown-toggle"><div class="icon-embed-xsmall w-embed"><svg width="100%" height="100%" viewbox="0 0 24 24" fill="none" preserveaspectratio="xMidYMid meet" aria-hidden="true" role="img"><mask id="mask0_2740_3290" style="mask-type:alpha" maskunits="userSpaceOnUse" x="0" y="0" width="24" height="24"><rect width="24" height="24" transform="matrix(-1 0 0 1 24 0)" fill="#D9D9D9"></rect></mask><g mask="url(#mask0_2740_3290)"><path d="M17.3128 21C17.7843 21 18.1833 20.8434 18.51 20.5303C18.8367 20.2171 19 19.8345 19 19.3826V9.19638C19 8.74442 18.8367 8.36185 18.51 8.0487C18.1833 7.73554 17.7843 7.57896 17.3128 7.57896H15.5V7.35527C15.5 6.42841 15.1584 5.63749 14.4751 4.98249C13.7919 4.3275 12.9668 4 12 4C11.0332 4 10.2081 4.3275 9.52489 4.98249C8.84164 5.63749 8.50001 6.42841 8.50001 7.35527V7.57896H6.68719C6.21574 7.57896 5.81667 7.73554 5.49 8.0487C5.16333 8.36185 5 8.74442 5 9.19638V19.3826C5 19.8345 5.16333 20.2171 5.49 20.5303C5.81667 20.8434 6.21574 21 6.68719 21H17.3128ZM17.3128 19.6579H6.68719C6.61539 19.6579 6.54957 19.6292 6.48972 19.5719C6.4299 19.5145 6.39998 19.4514 6.39998 19.3826V9.19638C6.39998 9.12754 6.4299 9.06444 6.48972 9.00707C6.54957 8.94972 6.61539 8.92104 6.68719 8.92104H8.50001V10.9342C8.50001 11.1246 8.56702 11.2841 8.70103 11.4126C8.83504 11.541 9.00136 11.6053 9.19999 11.6053C9.39862 11.6053 9.56494 11.541 9.69895 11.4126C9.83296 11.2841 9.89997 11.1246 9.89997 10.9342V8.92104H14.1V10.9342C14.1 11.1246 14.167 11.2841 14.301 11.4126C14.4351 11.541 14.6014 11.6053 14.8 11.6053C14.9986 11.6053 15.165 11.541 15.299 11.4126C15.433 11.2841 15.5 11.1246 15.5 10.9342V8.92104H17.3128C17.3846 8.92104 17.4504 8.94972 17.5103 9.00707C17.5701 9.06444 17.6 9.12754 17.6 9.19638V19.3826C17.6 19.4514 17.5701 19.5145 17.5103 19.5719C17.4504 19.6292 17.3846 19.6579 17.3128 19.6579ZM14.1 7.57896H9.89997V7.35527C9.89997 6.79433 10.1037 6.31857 10.5111 5.92798C10.9186 5.53739 11.4149 5.34209 12 5.34209C12.5851 5.34209 13.0814 5.53739 13.4889 5.92798C13.8963 6.31857 14.1 6.79433 14.1 7.35527V7.57896Z" fill="white"></path></g></svg></div><div li-element="mini-cart-item-count" class="nav_shop-quantity" x-data="{ items: 0 }" x-text="items" @carttotalitems.window="items = event.detail">1</div></div><nav li-element="mini-cart-container" class="nav_mini-cart-holder w-dropdown-list" :class="open || 'mini-cart-closed'"><div li-element="dropdown-toggle" class="nav_mini-cart-close" data-dropdowntoggle="" @click="LiquifyHelper.triggerClick($event.target.closest('.w-dropdown').querySelector('.w-dropdown-toggle.w--open'))"></div><div class="mini-cart_component text-color-primary"><div li-element="mini-cart-full" class="mini-cart_full" :style="total.items < 1 && { display: 'none' }"><div class="mini-cart_header"><div class="heading-style-h4">Mein Warenkorb</div><img src="{{ 'blockmine-menu-button-schliessen.svg' | asset_url }}" loading="eager" li-element="dropdown-toggle" alt="Schließen Button" class="icon-embed-small is-closer" data-dropdowntoggle="" @click="LiquifyHelper.triggerClick($event.target.closest('.w-dropdown').querySelector('.w-dropdown-toggle.w--open'))">
</div><div class="mini-cart_line-item no-scrollbar"><ul role="list" class="mini-cart_line-item_list w-list-unstyled"><template x-for="product in products" :key="product.key">
    <li li-element="mini-cart-item" class="mini-cart_line-item_item" x-init="getCart()"><img src="../images/platzhalter.svg" loading="lazy" alt="" class="mini-cart_line-item_img" x-bind:src="product.image">
<div class="mini-cart_line-item_product-info"><div class="mini-cart_line-item_product-inner"><div class="max-width-xxsmall"><div li-js-object="product.title" class="text-size-regular text-weight-bold" x-text="product.title">Antminer S19j Pro+ 120TH</div></div><div class="mini-cart_line-item_price"><div li-js-price="product.price" class="subline" x-text="moneyFormat(product.price)">14,99 $</div><template x-if="product.price < product.original_price">
            <div li-js-if="product.price < product.original_price">
        <div li-js-price="product.original_price" class="subline text-style-strikethrough text-style-muted" x-text="moneyFormat(product.original_price)">14,99 $</div>        </div>
    </template>
</div></div><div class="mini-cart_line-item_product-secondary"><div class="mini-cart_line-item_quantity"><div><div li-element="mini-cart-item-decrease" class="icon-embed-xxsmall is-pointer w-embed" :productprop="product" @click="$dispatch('decreasecartitem', { product: product.id, quantity: product.quantity, action: 'decrease' })"><svg width="100%" height="100%" viewbox="0 0 14 14" fill="none" preserveaspectratio="xMidYMid meet" aria-hidden="true" role="img"><mask id="mask0_2173_6854" style="mask-type:alpha" maskunits="userSpaceOnUse" x="0" y="0" width="14" height="14"><rect width="14" height="14" fill="#D9D9D9"></rect></mask><g mask="url(#mask0_2173_6854)"><path d="M6.22641 7.77285H2.63574V6.22698H6.22641L7.77227 6.22693L11.3629 6.22698V7.77285H7.77227H6.22641Z" fill="#0F0F0F"></path></g></svg></div></div><input li-element="mini-cart-item-quantity" class="mini-cart_line-item_quantity-adjust" value="1" :productprop="product" @blur="$dispatch('setcartitem', { product: product.id, quantity: product.quantity })" x-model="product.quantity">
<div><div li-element="mini-cart-item-increase" class="icon-embed-xxsmall is-pointer w-embed" :productprop="product" @click="$dispatch('increasecartitem', { product: product.id, quantity: product.quantity, action: 'increase' })"><svg width="100%" height="100%" viewbox="0 0 14 14" fill="none" preserveaspectratio="xMidYMid meet" aria-hidden="true" role="img"><mask id="mask0_2173_6858" style="mask-type:alpha" maskunits="userSpaceOnUse" x="0" y="0" width="14" height="14"><rect width="14" height="14" fill="#D9D9D9"></rect></mask><g mask="url(#mask0_2173_6858)"><path d="M6.22641 7.77276H2.63574V6.2269H6.22641V2.63623H7.77227V6.2269H11.3629V7.77276H7.77227V11.3634H6.22641V7.77276Z" fill="#0F0F0F"></path></g></svg></div></div></div><div li-element="mini-cart-item-remove" :productprop="product" @click="$dispatch('setcartitem', { product: product.id, quantity: 0 })"><div class="icon-embed-xxsmall is-remove is-pointer w-embed"><svg width="100%" height="100%" viewbox="0 0 16 16" fill="none" preserveaspectratio="xMidYMid meet" aria-hidden="true" role="img"><mask id="mask0_2142_7370" style="mask-type:alpha" maskunits="userSpaceOnUse" x="0" y="0" width="16" height="16"><rect width="16" height="16" fill="#D9D9D9"></rect></mask><g mask="url(#mask0_2142_7370)"><path d="M4.66406 14C4.2974 14 3.98351 13.8694 3.7224 13.6083C3.46128 13.3472 3.33073 13.0333 3.33073 12.6667V4H2.66406V2.66667H5.9974V2H9.9974V2.66667H13.3307V4H12.6641V12.6667C12.6641 13.0333 12.5335 13.3472 12.2724 13.6083C12.0113 13.8694 11.6974 14 11.3307 14H4.66406ZM11.3307 4H4.66406V12.6667H11.3307V4ZM5.9974 11.3333H7.33073V5.33333H5.9974V11.3333ZM8.66406 11.3333H9.9974V5.33333H8.66406V11.3333Z" fill="#050400"></path></g></svg></div></div></div></div></li></template>
</ul></div><div class="mini-cart_footer"><div class="mini-cart_footer_total"><div class="mini-cart_footer_total-inner"><p class="text-size-regular">Gesamtkosten</p><div><div li-js-price="total.price" class="heading-style-h6" x-text="moneyFormat(total.price)">14,99 $</div><template x-if="total.price < original_total_price">
            <div li-js-if="total.price < original_total_price" class="mini-cart_footer_total-wrapper">
        <div li-js-price="original_total_price" class="subline text-style-strikethrough text-style-muted" x-text="moneyFormat(original_total_price)">14,99 $</div>        </div>
    </template>
</div></div></div><div li-element="mini-cart-api-response" class="mini-cart_footer-message hide"><div class="mini-cart_footer-message-item"><div class="text-size-regular text-weight-bold">Message</div><div li-js-object="cartApiResponse?.result?.message" class="text-size-regular text-weight-bold" x-text="cartApiResponse?.result?.message">14,99 $</div></div></div><a li-object:href="routes.cart_url" href="{{ routes.cart_url }}" class="button is-secondary hide w-button">Cart</a><a x-bind:href="'/checkout'" href="#" class="button is-checkout w-inline-block"><div class="icon-embed-xsmall w-embed"><svg width="100%" height="100%" viewbox="0 0 23 22" fill="none" preserveaspectratio="xMidYMid meet" aria-hidden="true" role="img"><mask id="mask0_2142_7382" style="mask-type:alpha" maskunits="userSpaceOnUse" x="0" y="0" width="23" height="22"><rect x="0.929688" width="22" height="22" fill="#D9D9D9"></rect></mask><g mask="url(#mask0_2142_7382)"><path d="M5.51302 20.1672C5.00885 20.1672 4.57726 19.9877 4.21823 19.6287C3.8592 19.2697 3.67969 18.8381 3.67969 18.3339V7.3339C3.67969 6.82974 3.8592 6.39814 4.21823 6.03911C4.57726 5.68008 5.00885 5.50057 5.51302 5.50057H7.34635C7.34635 4.23251 7.79323 3.15161 8.68698 2.25786C9.58073 1.36411 10.6616 0.917236 11.9297 0.917236C13.1977 0.917236 14.2786 1.36411 15.1724 2.25786C16.0661 3.15161 16.513 4.23251 16.513 5.50057H18.3464C18.8505 5.50057 19.2821 5.68008 19.6411 6.03911C20.0002 6.39814 20.1797 6.82974 20.1797 7.3339V18.3339C20.1797 18.8381 20.0002 19.2697 19.6411 19.6287C19.2821 19.9877 18.8505 20.1672 18.3464 20.1672H5.51302ZM5.51302 18.3339H18.3464V7.3339H5.51302V18.3339ZM11.9297 12.8339C13.1977 12.8339 14.2786 12.387 15.1724 11.4933C16.0661 10.5995 16.513 9.51863 16.513 8.25057H14.6797C14.6797 9.01446 14.4123 9.66376 13.8776 10.1985C13.3429 10.7332 12.6936 11.0006 11.9297 11.0006C11.1658 11.0006 10.5165 10.7332 9.98177 10.1985C9.44705 9.66376 9.17969 9.01446 9.17969 8.25057H7.34635C7.34635 9.51863 7.79323 10.5995 8.68698 11.4933C9.58073 12.387 10.6616 12.8339 11.9297 12.8339ZM9.17969 5.50057H14.6797C14.6797 4.73668 14.4123 4.08738 13.8776 3.55265C13.3429 3.01793 12.6936 2.75057 11.9297 2.75057C11.1658 2.75057 10.5165 3.01793 9.98177 3.55265C9.44705 4.08738 9.17969 4.73668 9.17969 5.50057Z" fill="#050400"></path></g></svg></div><div>Jetzt sicher zur Kasse</div></a></div></div><div li-cloak="hide" li-element="mini-cart-empty" :style="total.items && { display: 'none' }"><div class="mini-cart_header"><div class="heading-style-h4">Mein Warenkorb</div><img src="{{ 'blockmine-menu-button-schliessen.svg' | asset_url }}" loading="eager" li-element="dropdown-toggle" alt="Schließen Button" class="icon-embed-small is-closer" data-dropdowntoggle="" @click="LiquifyHelper.triggerClick($event.target.closest('.w-dropdown').querySelector('.w-dropdown-toggle.w--open'))">
</div><div class="mini-cart_empty"><div class="text-size-regular is-sub">Keine Produkte ausgewählt</div></div></div></div></nav></div>
